
<script type="text/javascript" src="{$template_dir}js/clipboard.js"></script>
<div id="newshelfnav" class="newhorizontalnav">
    <div class="list-1" >
        <ul>
            <li class="{if !$action || $action === 'default'}active{/if}">
                <a href="?cmd={$modulename}"><span>Direct Cart Links</span></a>
            </li>
            <li class="{if $action === 'carts'}active{/if}">
                <a href="?cmd={$modulename}&action=carts"><span>Abandoned Carts</span></a>
            </li>
        </ul>
    </div>
</div>

{if !$action || $action === 'default'}

    {literal}
        <script>
            $(function () {
                let time = 0;
                $('.linkadmnote textarea.adminnote').on('input', function () {
                    var form = $(this).closest('form');
                    clearTimeout(time);
                    form.find('.saving-success').hide();
                    form.find('.saving-loading').show();
                    time = setTimeout(function() {
                        $.ajax({
                            type: 'POST',
                            data: form.serialize(),
                            url: form.attr('action'),
                            success: function () {
                                form.find('.saving-loading').hide();
                                form.find('.saving-success').show();
                            },
                            error: function () {
                                form.find('.saving-loading').hide();
                                form.find('.saving-success').hide();
                                alert('Error! Note has not been saved!');
                            }
                        })
                    }, 1000);
                });
            });
        </script>
    {/literal}

    <div class="nicers" style="border:none;padding:10px;">
        {if $logs}
            <div id="listform">
                <div id="serializeit"><ul style="border:solid 1px #ddd;border-bottom:none;" id="grab-sorter" >
                        {foreach from=$logs item=l}
                            <li style="background:#ffffff">
                                <div style="border-bottom:solid 1px #ddd;">
                                    <table width="100%" cellspacing="0" cellpadding="5" border="0">
                                        <tbody>
                                        <tr>
                                            <td width="120" valign="middle">
                                                <a class="menuitm menu-auto" onclick="return confirm('Are you sure you wish to delete this link?')" title="delete"  href="?cmd=module&module={$moduleid}&make=delete&id={$l.id}"><i class="fa fa-trash" aria-hidden="true"></i></a>
                                                <a class="menuitm menu-auto" href="{$l.link}" target="_blank"><i class="fa fa-external-link" aria-hidden="true"></i></a>
                                                <a class="menuitm menu-auto copy-link"  data-link="{$l.link}" onclick="return false;" data-original-title="" title=""><i class="fa fa-files-o f-a" aria-hidden="true"></i></a>

                                            </td>
                                            <td>
                                                <input style="width: 100%;" readonly="readonly" type="text" value="{$l.link}"/>
                                            </td>
                                            <td width="350" valign="top" style="background:#F0F0F3;color:#767679;font-size:11px">
                                                Product/s: <br>
                                                <strong>{$l.pname}</strong><br />
                                                {if $l.dname}
                                                    Domain/s: <br>
                                                    <strong>{$l.dname}</strong><br />
                                                {/if}
                                                Generated by:
                                                <strong>{$l.firstname} {$l.lastname}</strong><br/>
                                                On: {$l.date_created|dateformat:$date_format}
                                            </td>
                                            <td width="350" valign="top" style="background:#F0F0F3;color:#767679;font-size:11px">
                                                <form action="?cmd=directcartlinks&action=default&make=savenote" class="linkadmnote">
                                                    <div>
                                                        <div class="pull-left">Note (admin only): </div>
                                                        <div class="pull-right">
                                                            <div class="saving-loading" style="display: none;color: #ff9837">
                                                                <i class="fa fa-spinner fa-spin" style="color: #ff9837"></i>
                                                                <span>Saving...</span>
                                                            </div>
                                                            <div class="saving-success" style="display: none;color: green">
                                                                <i class="fa fa-check" style="color: green"></i>
                                                                Saved!
                                                            </div>
                                                        </div>
                                                        <div class="clearfix"></div>
                                                    </div>
                                                    <textarea name="note" rows="2" class="form-control adminnote">{$l.note}</textarea>
                                                    <input type="hidden" name="id" value="{$l.id}">
                                                    {securitytoken}
                                                </form>
                                            </td>
                                        </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </li>
                        {/foreach}
                    </ul>
                </div>
            </div>
        {else}
            <div id="bsmetered" class="blank_state_smaller blank_domains">
                <div class="blank_info">
                    <h3>You dont have any custom direct links generated yet.</h3>
                    Using this feature you can generate custom order links containing exact product configuration you need.
                    <div class="clear"></div>
                    <br>
                    <a href="https://hostbill.atlassian.net/wiki/spaces/DOCS/pages/352977277/Custom+Direct+Cart+Links" class="new_control" target="_blank" rel="noreferrer noopener nofollow"><span class="addsth"><strong>Learn how</strong></span></a>
                    <div class="clear"></div>
                </div>
            </div>
        {/if}
    </div>
{elseif $action === 'carts'}
    {include file="topmenu.tpl"}
    <div style="padding:10px ;">
        <div class="box box-primary no-padding">
            <div class="box-body">
                </div>
                <div class="clear clearfix"></div>
                <div class="blu">
                    <div class="left">
                        <span>With selected:</span>
                        <button class="btn_action btn btn-sm btn-default" onclick="if (confirm('Are you sure you want to send reminder E-mail?'))return emailCarts(false);">Send reminder Email</button>
                        <button class="btn_action btn btn-sm btn-default" onclick="if (confirm('Are you sure?')) deleteCarts();" style="color: red">Delete</button>
                    </div>
                    <div class="clear"></div>
                </div>
                <a href="?cmd=directcartlinks&action=carts" id="currentlist" style="display:none" updater="#updater"></a>
                <input type="hidden" value="{$totalpages}" name="totalpages2" id="totalpages"/>
                <table cellspacing="0" cellpadding="3" border="0" width="100%" class="table whitetable hover">
                    <thead>
                    <tr>
                        <th width="30"><input type="checkbox" id="checkall"></th>
                        <th width="80"><a href="?cmd=directcartlinks&action=carts&orderby=id|ASC" class="sortorder">ID</a></th>
                        <th width="150"><a href="?cmd=directcartlinks&action=carts&orderby=admin_id|ASC" class="sortorder">Admin</a></th>
                        <th width="180"><a href="?cmd=directcartlinks&action=carts&orderby=client_id|ASC" class="sortorder">Client</a></th>
                        {if $brands|@count > 1}
                            <th>Host</th>
                        {/if}
                        <th width="200">Link</th>
                        <th>Products</th>
                        <th width="120"><a href="?cmd=directcartlinks&action=carts&orderby=total|ASC" class="sortorder">Total</a></th>
                        <th width="100"><a href="?cmd=directcartlinks&action=carts&orderby=date_created|ASC" class="sortorder">Created</a></th>
                        <th width="100"><a href="?cmd=directcartlinks&action=carts&orderby=date_updated|ASC" class="sortorder">Updated</a></th>
                        <th width="180"><a href="?cmd=directcartlinks&action=carts&orderby=date_email|ASC" class="sortorder">Reminder Emails</a></th>
                        <th width="250"></th>
                    </tr>
                    </thead>
                    <tbody id="updater">
                        {include file="ajax.default.tpl"}
                    </tbody>
                    <tbody id="psummary">
                    <tr>
                        <th colspan="100%">
                            {$lang.showing} <span id="sorterlow">{$sorterlow}</span> - <span
                                    id="sorterhigh">{$sorterhigh}</span> {$lang.of} <span
                                    id="sorterrecords">{$sorterrecords}</span>
                        </th>
                    </tr>
                    </tbody>
                </table>
                <div class="blu">
                    <div class="right">
                        <div class="pagination"></div>
                    </div>
                    <div class="clear"></div>
                </div>
            </div>
        </div>
    </div>

{literal}
    <script>
        var _token = {/literal}'{$security_token}'{literal};

        $(function () {
            var _l = $('input[name="selected[]"]:checked').length;
            $('.btn_action').prop('disabled', _l === 0);
        });
        $(document).on('change', '.check, #checkall', function () {
            var _l = $('input[name="selected[]"]:checked').length;
            $('.btn_action').prop('disabled', _l === 0);
        });
        $('.filterform').on('submit', function () {
            $('#checkall').prop('checked', false);
            $('.btn_action').prop('disabled', true);
        });

        function emailCarts(selected) {
            $('#updater').addLoader();
            var items = [];
            var tpl_id = $('#cart-emailreminder').find('select[name="tpl_id"]').val();
            if (!selected) {
                items = $('input[name="selected[]"]:checked').serializeArray()
            } else {
                items.push({
                    name: "selected[]",
                    value: selected
                });
            }
            console.log(items);
            $.ajax({
                type: 'POST',
                url: '?cmd=directcartlinks&action=carts&make=email&tpl_id=' + tpl_id + '&security_token=' + _token,
                data: items,
                success: function (data) {
                    parse_response(data);
                    $('#updater').html(data);
                    $('#cart-emailreminder').modal('hide');
                    $('#checkall').prop('checked', false);
                    $('.btn_action').prop('disabled', true);
                }
            });
        }

        function deleteCarts() {
            $('#updater').addLoader();
            $.ajax({
                type: 'POST',
                url: '?cmd=directcartlinks&action=carts&make=delete&security_token=' + _token,
                data: $('input[name="selected[]"]:checked').serializeArray(),
                success: function (data) {
                    parse_response(data);
                    $('#updater').html(data);
                    $('#checkall').prop('checked', false);
                    $('.btn_action').prop('disabled', true);
                }
            });
        }



    </script>
{/literal}

{/if}
{literal}
    <script> new Clipboard('.copy-link', {
            text: function (trigger) {
                var link = $(trigger).data('link');
                var tooltiptitle = 'Copied';
                $(".tooltip").tooltip("destroy");
                $(trigger).tooltip({title:tooltiptitle,trigger:'manual',animation:false}).tooltip('show');
                setTimeout(function(){
                    $(trigger).tooltip('hide');
                }, 3000);
                return link;
            }
        });</script>{/literal}